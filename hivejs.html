<!DOCTYPE html>
<html>
<head>
	<title>Post voters</title>
	<meta charset="utf-8">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/@hiveio/hive-js/dist/hive.min.js"></script>
<script>
	var B = 1000000000;
	var author = 'fat.music';
	var limit = 3;
	var voters = [];
	var sum_share = 0;
	
	var query = {
		tag: author,
		limit: limit
	};
	$(document).ready(function(){
		$("#submit").click(function(event){
			event.preventDefault();
			author = $('#author').val();
			limit = $('#limit').val();
			query = {
				tag: author,
				limit: limit
			};
			loadHiveDiscussionsByBlog();
			drawTable();
		});
	});
	
	function loadHiveDiscussionsByBlog(){
		voters = [];
		sum_share = 0;
		hive.api.getDiscussionsByBlog(query, function(err, posts) {
			console.log(posts);
			posts.forEach(function(post) {
				if (author === post.author) {
					let net_rshares = post.net_rshares;
					let pending_payout_value = parseFloat(post.pending_payout_value.replace(' HBD'));
					post.active_votes.forEach(function(vote) {
						sum_share += vote.rshares;
						if (voter = voters.find(v => v.name === vote.voter)) {
							voter.votes++;
							voter.share += vote.rshares;
							voter.payout_value += (vote.rshares / net_rshares) * pending_payout_value;
							
						} else {
							console.log('rshares, net_rshares', vote.rshares, net_rshares);
							console.log('%', vote.rshares / net_rshares);
							console.log('hdb', (vote.rshares / net_rshares) * pending_payout_value);
							voters.push({
								name: vote.voter,
								votes: 1,
								share: vote.rshares,
								payout_value: (vote.rshares / net_rshares) * pending_payout_value,
							});
						}
					});
					console.log(net_rshares);
				}
			});
			voters.sort((a, b) => b.share - a.share);
			drawTable();
		});
	}
	
	function drawTable(){
		$('#tbody').html('');
		voters.forEach(function(vote) {
			$('#tbody').append('<tr><td>@'+vote.name+'</td><td>'+vote.votes+'</td><td>'+vote.share+'</td><td>'+vote.payout_value.toFixed(3)+' HBD</td><td>'+((100 * vote.share) / sum_share).toFixed(0)+' %</td></tr>');
		});
	}

</script>
<style>
td, th {
  text-align: right;
  font-family: "Lucida Console", "Courier New", monospace;
}
</style>
</head>
<body style="">
<div class="container">
	<div class="row">
		<div class="col-md-12">
			<div class="row">
				<div class="col-md-12">
					<label class="form-label">Insert Username, Post limit and press Submit button</label>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
								<div class="input-group mb-3">
  <span class="input-group-text" id="basic-addon1">@</span>
  <input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1" id="author" value="fat.music">
  <span class="input-group-text" id="basic-addon1">#</span>
  <input type="text" class="form-control" placeholder="Limit" aria-label="Limit" aria-describedby="basic-addon1" value=3 id="limit">
  <button class="btn btn-outline-secondary" type="button" id="submit">Submit</button>
</div>
							</div>

						</div>
						<div class="row">
							<div class="col-md-12">
								<table class="table table-dark table-striped table-sm">
  <thead>
    <tr>
      <th scope="col">User</th>
      <th scope="col">Votes</th>
      <th scope="col">Share</th>
      <th scope="col">Payout</th>
	  <th scope="col">%</th>
    </tr>
  </thead>
  <tbody id="tbody">
  </tbody>
								<table>
							</div>
						</div>
				
			</div>
		</div>
	</div>
</div>
</html>